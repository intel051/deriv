<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub PDF 검색기</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
        // PDF.js worker 설정
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="container mx-auto p-4 md:p-8 max-w-2xl">
        <div class="bg-white rounded-xl shadow-lg p-6 md:p-8">
            <header class="text-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800">사내 규정 PDF 검색</h1>
                <p class="text-gray-500 mt-2">GitHub에 저장된 규정 PDF 파일의 내용을 검색합니다.</p>
            </header>

            <div class="search-area">
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="searchInput" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition" placeholder="궁금한 규정을 검색해보세요...">
                    <button id="searchButton" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300 ease-in-out">
                        검색
                    </button>
                </div>
            </div>

            <div id="resultArea" class="mt-6">
                <div id="loader" class="hidden flex flex-col items-center justify-center text-center p-4">
                    <div class="loader"></div>
                    <p class="text-gray-600 mt-3">Gemini API가 PDF를 읽고 답변을 생성중입니다... <br>처음 실행 시 PDF 로딩으로 시간이 걸릴 수 있습니다.</p>
                </div>
                <div id="error" class="hidden text-red-600 bg-red-100 p-4 rounded-lg"></div>
                <div id="summary" class="text-gray-700 bg-gray-50 p-5 rounded-lg prose"></div>
            </div>
        </div>
        <footer class="text-center mt-6">
            <p class="text-sm text-gray-500">Powered by Gemini API & PDF.js</p>
        </footer>
    </div>

    <script>
        // =================================================================================
        // 설정: 여기에 본인의 GitHub PDF 파일 Raw URL을 입력하세요.
        // 예: https://raw.githubusercontent.com/username/repo/main/rule.pdf
        // =================================================================================
        const pdfUrls = [
            'https://raw.githubusercontent.com/intel051/derive/refs/heads/main/rule.pdf', // <- 'rule.pdf' 파일 URL로 교체하세요
            'https://raw.githubusercontent.com/intel051/derive/refs/heads/main/rule2.pdf' // <- 'rule2.pdf' 파일 URL로 교체하세요
        ];
        // =================================================================================

        const searchButton = document.getElementById('searchButton');
        const searchInput = document.getElementById('searchInput');
        const resultArea = document.getElementById('resultArea');
        const loader = document.getElementById('loader');
        const errorDiv = document.getElementById('error');
        const summaryDiv = document.getElementById('summary');

        let combinedPdfText = '';

        // PDF에서 텍스트를 추출하는 함수
        async function extractTextFromPdf(url) {
            try {
                // CORS 프록시를 사용하여 GitHub Raw 파일 접근
                const proxyUrl = `https://cors-anywhere.herokuapp.com/`;
                const loadingTask = pdfjsLib.getDocument(proxyUrl + url);
                const pdf = await loadingTask.promise;
                let text = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    text += textContent.items.map(item => item.str).join(' ');
                }
                return text;
            } catch (err) {
                console.error(`Error loading or parsing PDF from ${url}:`, err);
                throw new Error(`PDF 파일을 불러오는 데 실패했습니다: ${url}. CORS 문제일 수 있습니다.`);
            }
        }

        // 모든 PDF를 미리 로드하는 함수
        async function preloadPdfs() {
            console.log('PDF 사전 로딩 시작...');
            try {
                const textPromises = pdfUrls.map(url => extractTextFromPdf(url));
                const texts = await Promise.all(textPromises);
                combinedPdfText = texts.join('\n\n---\n\n');
                console.log('모든 PDF 로딩 및 텍스트 추출 완료.');
            } catch (err) {
                showError(err.message);
                console.error('PDF 사전 로딩 실패:', err);
            }
        }

        // Gemini API 호출 함수 (Exponential Backoff 포함)
        async function callGeminiApi(context, query) {
            const apiKey = "AIzaSyDfpal-sPS5EeCLYrvmeVnc_sA69L_EQ8M"; // Gemini API 키 (필요 시)
            const apiUrl = `https://generativelanguage.googleapis.com/v1/models/gemini-2.5-pro:generateContent?key=${apiKey}`;

            const systemPrompt = "You are an AI assistant specialized in searching and summarizing company regulations. Based on the provided text from the company's rule PDFs, answer the user's question concisely and accurately. If the answer is not in the text, state that the information could not be found in the provided documents.";
            
            const userPrompt = ` 당신은 사내 규정 전문가 입니다. 아래의 사내 규정 텍스트를 바탕으로 답변을 찾아서 가독성 좋게 정리해주세요.\n\n[질문]:\n${query}\n\n[사내 규정 텍스트]:\n${context}`;

            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            let response;
            let retries = 3;
            let delay = 1000;

            for (let i = 0; i < retries; i++) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const candidate = result.candidates?.[0];
                        if (candidate && candidate.content?.parts?.[0]?.text) {
                            return candidate.content.parts[0].text;
                        } else {
                            throw new Error('API 응답에서 유효한 텍스트를 찾을 수 없습니다.');
                        }
                    } else {
                         throw new Error(`API 요청 실패: ${response.status} ${response.statusText}`);
                    }
                } catch (err) {
                    console.error(`API 호출 시도 ${i + 1} 실패:`, err);
                    if (i < retries - 1) {
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2; // Exponential backoff
                    } else {
                        throw err; // 마지막 시도 후 에러 던지기
                    }
                }
            }
        }

        function showLoader(show) {
            loader.classList.toggle('hidden', !show);
        }

        function showError(message) {
            errorDiv.textContent = `오류가 발생했습니다: ${message}`;
            errorDiv.classList.remove('hidden');
            summaryDiv.innerHTML = '';
        }

        function showSummary(text) {
             // 마크다운 형식의 텍스트를 HTML로 변환 (간단한 버전)
            let html = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold
                .replace(/\*(.*?)\*/g, '<em>$1</em>')     // Italic
                .replace(/`([^`]+)`/g, '<code>$1</code>') // Inline code
                .replace(/\n/g, '<br>'); // Newlines
            summaryDiv.innerHTML = html;
            errorDiv.classList.add('hidden');
        }

        async function handleSearch() {
            const query = searchInput.value.trim();
            if (!query) {
                showError('검색어를 입력해주세요.');
                return;
            }

            if (!combinedPdfText) {
                showError('PDF 파일이 아직 로딩 중이거나 로딩에 실패했습니다. 잠시 후 다시 시도해주세요.');
                return;
            }

            showLoader(true);
            errorDiv.classList.add('hidden');
            summaryDiv.innerHTML = '';

            try {
                const summary = await callGeminiApi(combinedPdfText, query);
                showSummary(summary);
            } catch (err) {
                console.error("Gemini API 호출 실패:", err);
                showError('Gemini API로부터 답변을 가져오는 데 실패했습니다. 잠시 후 다시 시도해주세요.');
            } finally {
                showLoader(false);
            }
        }

        searchButton.addEventListener('click', handleSearch);
        searchInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                handleSearch();
            }
        });

        // 페이지 로드 시 PDF 사전 로딩 시작
        window.onload = preloadPdfs;

    </script>
</body>
</html>


