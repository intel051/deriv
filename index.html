<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>업무 규정 Q&A 챗봇</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        body {
            /* 폰트를 Pretendard로 변경하고, 시스템 기본 폰트를 fallback으로 지정 */
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, 'Helvetica Neue', 'Segoe UI', 'Apple SD Gothic Neo', 'Noto Sans KR', 'Malgun Gothic', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', sans-serif;
        }
        /* pdf.js worker 설정 */
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';
        .prose p { margin-bottom: 1rem; }
        .prose ul { list-style-position: inside; }
        .prose li { margin-bottom: 0.5rem; }
        .prose strong { font-weight: 700; }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 antialiased">

    <div class="container mx-auto max-w-3xl px-4 py-8 md:py-16">
        
        <header class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white">업무 규정 Q&A 챗봇</h1>
            <p class="text-gray-600 dark:text-gray-400 mt-3 text-lg">시행세칙과 업무규정 PDF를 기반으로 답변해 드려요.</p>
        </header>

        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 mb-8">
            <h2 class="text-sm font-semibold text-gray-500 dark:text-gray-400 mb-2">정보 출처:</h2>
            <ul class="space-y-1">
                <li class="flex items-center">
                    <svg class="w-4 h-4 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                    <span class="text-gray-700 dark:text-gray-300">시행세칙.pdf</span>
                </li>
                 <li class="flex items-center">
                    <svg class="w-4 h-4 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                    <span class="text-gray-700 dark:text-gray-300">업무규정.pdf</span>
                </li>
                <li class="flex items-center">
                    <svg class="w-4 h-4 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                    <span class="text-gray-700 dark:text-gray-300">rule.pdf</span>
                </li>
                 <li class="flex items-center">
                    <svg class="w-4 h-4 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                    <span class="text-gray-700 dark:text-gray-300">rule2.pdf</span>
                </li>
            </ul>
        </div>

        <form id="qa-form" class="space-y-4">
            <div>
                <label for="question" class="sr-only">질문</label>
                <textarea id="question" rows="4" class="w-full px-4 py-3 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow text-base" placeholder="규정과 관련하여 궁금한 점을 입력하세요..." required></textarea>
            </div>
            <button type="submit" id="submit-button" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-gray-900 transition-colors duration-200 flex items-center justify-center text-base">
                <span id="button-text">답변 생성하기</span>
                <svg id="button-loader" class="animate-spin ml-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </button>
        </form>

        <div id="result-container" class="mt-10 hidden">
             <div id="status-container" class="mb-4 p-4 text-sm text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-800 rounded-lg">
                <p id="status-message">...</p>
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 mt-2">
                  <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
            
            <div id="result-box" class="p-6 bg-white dark:bg-gray-800 rounded-xl shadow-md border border-gray-200 dark:border-gray-700 hidden">
                 <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Gemini AI의 답변</h2>
                 <div id="result-content" class="prose prose-blue dark:prose-invert max-w-none text-gray-700 dark:text-gray-300"></div>
            </div>
        </div>
        
    </div>

    <script>
        // --- DOM Elements ---
        const qaForm = document.getElementById('qa-form');
        const submitButton = document.getElementById('submit-button');
        const buttonText = document.getElementById('button-text');
        const buttonLoader = document.getElementById('button-loader');
        const resultContainer = document.getElementById('result-container');
        const statusContainer = document.getElementById('status-container');
        const statusMessage = document.getElementById('status-message');
        const progressBar = document.getElementById('progress-bar');
        const resultBox = document.getElementById('result-box');
        const resultContent = document.getElementById('result-content');

        // --- PDF File Information (수정된 부분) ---
        const PDF_FILES = [
            { name: "rule.pdf", url: "https://raw.githubusercontent.com/intel051/derive/main/rule.pdf", fallbackUrl: "https://raw.githubusercontent.com/intel051/derive/master/rule.pdf" },
            { name: "rule2.pdf", url: "https://raw.githubusercontent.com/intel051/derive/main/rule2.pdf", fallbackUrl: "https://raw.githubusercontent.com/intel051/derive/master/rule2.pdf" },
        ];
        
        // --- Functions ---
        
        /**
         * Fetches and parses a PDF file, returning its text content.
         * Tries a primary URL and falls back to a secondary URL if the first fails.
         */
        async function fetchAndParsePDF(pdfInfo) {
            let pdfUrl = pdfInfo.url;
            try {
                const response = await fetch(pdfUrl);
                if (!response.ok) {
                    console.warn(`Failed to fetch from main branch for ${pdfInfo.name}, trying master...`);
                    pdfUrl = pdfInfo.fallbackUrl; // Try fallback URL
                    const fallbackResponse = await fetch(pdfUrl);
                    if(!fallbackResponse.ok) throw new Error(`Failed to fetch ${pdfInfo.name} from both main and master branches.`);
                }
                
                const pdfData = await (await fetch(pdfUrl)).arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
                let text = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    text += textContent.items.map(item => item.str).join(' ') + '\n';
                }
                return text;
            } catch (error) {
                console.error(`Error processing ${pdfInfo.name}:`, error);
                throw new Error(`'${pdfInfo.name}' 파일을 불러오는 데 실패했습니다. 파일 경로를 확인해주세요.`);
            }
        }

        /**
         * Calls the Gemini API with the provided context and question.
         */
        async function callGeminiAPI(context, question) {
            const apiKey = "AIzaSyDfpal-sPS5EeCLYrvmeVnc_sA69L_EQ8M";
            const apiUrl = `https://generativelanguage.googleapis.com/v1/models/gemini-2.5-pro:generateContent?key=${apiKey}`;

            const systemPrompt = `당신은 'rule', 'rule2' 문서에 대해 모든 것을 알고 있는 사내 규정 전문가입니다. 
            당신의 역할은 사용자의 질문에 대해 주어진 문서 내용에만 근거하여 명확하고 친절하게 답변하는 것입니다.
            - 답변은 반드시 제공된 문서 텍스트만을 기반으로 해야 합니다.
            - 문서에 없는 내용에 대해서는 절대 추측하거나 외부 정보를 사용하지 마세요.
            - 만약 질문에 대한 답이 문서에 없다면, "죄송하지만, 제공된 문서에서는 해당 내용을 찾을 수 없었습니다."라고 정확하게 답변해주세요.
            - 답변은 사용자가 이해하기 쉽도록 정리하고, 필요하다면 목록이나 단락을 사용하여 가독성을 높여주세요.
            - 답변은 항상 한국어로 해주세요.`;

            const userPrompt = `
            [문서 내용]
            ---
            ${context}
            ---

            [사용자 질문]
            ${question}
            `;

            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    throw new Error(`API Error: ${response.status} - ${errorBody.error.message}`);
                }
                
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Gemini API call failed:", error);
                throw new Error("AI 답변을 생성하는 데 실패했습니다. 잠시 후 다시 시도해 주세요.");
            }
        }
        
        /**
         * Manages the UI state (loading, success, error).
         */
        function setUIState(state, data = null) {
             // Reset UI elements
            submitButton.disabled = false;
            buttonLoader.classList.add('hidden');
            buttonText.textContent = '답변 생성하기';
            resultContainer.classList.remove('hidden');
            
            switch(state) {
                case 'loading':
                    submitButton.disabled = true;
                    buttonText.textContent = '처리 중...';
                    buttonLoader.classList.remove('hidden');
                    statusContainer.classList.remove('hidden');
                    resultBox.classList.add('hidden');
                    break;
                case 'success':
                    resultBox.classList.remove('hidden');
                    resultContent.innerHTML = data.replace(/\n/g, '<br>'); // Simple formatting
                    updateStatus('✅ 답변이 도착했습니다!', 100);
                    break;
                case 'error':
                    statusContainer.classList.remove('hidden');
                    resultBox.classList.add('hidden');
                    updateStatus(`❌ 오류: ${data}`, 100, true);
                    break;
                case 'initial':
                    resultContainer.classList.add('hidden');
                    statusContainer.classList.add('hidden');
                    resultBox.classList.add('hidden');
                    break;
            }
        }
        
        /**
         * Updates the status message and progress bar.
         */
        function updateStatus(message, progress, isError = false) {
            statusMessage.textContent = message;
            progressBar.style.width = `${progress}%`;
            progressBar.classList.toggle('bg-red-500', isError);
            progressBar.classList.toggle('bg-blue-600', !isError);
        }

        // --- Event Listener ---
        qaForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const question = document.getElementById('question').value.trim();
            if (!question) return;

            setUIState('loading');
            
            try {
                let combinedText = '';
                const totalFiles = PDF_FILES.length;

                for (let i = 0; i < totalFiles; i++) {
                    const file = PDF_FILES[i];
                    updateStatus(`[${i+1}/${totalFiles}] '${file.name}' 문서를 불러오는 중...`, (i / (totalFiles + 1)) * 100);
                    const text = await fetchAndParsePDF(file);
                    combinedText += `--- START OF ${file.name} ---\n${text}\n--- END OF ${file.name} ---\n\n`;
                }

                updateStatus(`[${totalFiles}/${totalFiles}] 문서 분석 완료! Gemini에게 질문하는 중...`, (totalFiles / (totalFiles + 1)) * 100);
                
                const answer = await callGeminiAPI(combinedText, question);
                
                setUIState('success', answer);

            } catch (error) {
                console.error(error);
                setUIState('error', error.message);
            }
        });
    </script>
</body>
</html>
