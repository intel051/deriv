<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>업무규정 AI 비서</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Pretendard Font CDN -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <!-- Marked.js CDN for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Pretendard 폰트 적용 */
        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, 'Helvetica Neue', 'Segoe UI', 'Apple SD Gothic Neo', 'Noto Sans KR', 'Malgun Gothic', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', sans-serif;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #result-card ol, #result-card ul { list-style-position: inside; padding-left: 1.5rem; }
        #result-card ol { list-style-type: decimal; }
        #result-card ul { list-style-type: disc; }
        #result-card h1, #result-card h2, #result-card h3 { font-weight: bold; margin-top: 1rem; margin-bottom: 0.5rem; }
        #result-card h1 { font-size: 1.5rem; }
        #result-card h2 { font-size: 1.25rem; }
        #result-card h3 { font-size: 1.1rem; }
        #result-card p { margin-bottom: 0.75rem; }
        #result-card a { color: #3b82f6; text-decoration: underline; }
        #result-card pre { background-color: #f3f4f6; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; overflow-x: auto;}
        #result-card code { font-family: 'Courier New', Courier, monospace; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="w-full max-w-3xl mx-auto bg-white rounded-2xl shadow-lg p-6 md:p-8 space-y-8">
        <!-- Header -->
        <header class="text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">업무규정 AI 비서</h1>
            <p class="text-gray-500 mt-2">업무규정 문서를 기반으로 무엇이든 물어보세요.</p>
        </header>

        <!-- Step 1: Document Loader (Automatic) -->
        <div class="space-y-4">
            <div class="flex items-center space-x-3">
                <div class="bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold text-lg">1</div>
                <h2 class="text-xl font-semibold text-gray-700">문서 로딩 상태</h2>
            </div>
            <div class="p-4 bg-gray-50 border rounded-lg">
                <p class="text-sm text-gray-600">아래 문서들이 자동으로 로딩됩니다:</p>
                <ul class="list-disc list-inside text-xs text-gray-500 mt-2 space-y-1">
                    <li>rule1.txt</li>
                    <li>rule2.txt</li>
                </ul>
            </div>
            <div id="doc-status" class="text-center text-sm font-medium h-5"></div>
        </div>

        <!-- Step 2: Q&A Section -->
        <div id="qa-section" class="space-y-4 opacity-50 pointer-events-none transition-opacity duration-500">
             <div class="flex items-center space-x-3">
                <div class="bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold text-lg">2</div>
                <h2 class="text-xl font-semibold text-gray-700">질문하기</h2>
            </div>
            <textarea id="query-input" rows="4" placeholder="예시) 재택근무 규정에 대해 알려주세요." class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"></textarea>
            <button id="ask-btn" class="w-full bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition duration-300 shadow-md">
                AI에게 질문하기
            </button>
        </div>

        <!-- Step 3: Result Display -->
        <div class="space-y-4">
            <div class="flex items-center space-x-3">
                <div class="bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold text-lg">3</div>
                <h2 class="text-xl font-semibold text-gray-700">답변</h2>
            </div>
            <div id="result-card" class="w-full min-h-[100px] p-4 bg-gray-50 border border-gray-200 rounded-lg">
                <div id="loader" class="hidden mx-auto loader"></div>
                <div id="result-text" class="text-gray-700 leading-relaxed">AI의 답변이 여기에 표시됩니다.</div>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const docStatus = document.getElementById('doc-status');
        const qaSection = document.getElementById('qa-section');
        const queryInput = document.getElementById('query-input');
        const askBtn = document.getElementById('ask-btn');
        const loader = document.getElementById('loader');
        const resultText = document.getElementById('result-text');
        
        // --- URL 변경 ---
        // cdn.jsdelivr.net 대신 raw.githubusercontent.com을 사용하여 직접 파일을 로드합니다.
        const defaultDocUrls = [
            'https://raw.githubusercontent.com/intel051/derive/main/rule1.txt',
            'https://raw.githubusercontent.com/intel051/derive/main/rule2.txt'
        ];
        let fullDocumentText = '';
        
        window.onload = loadDefaultDocs;
        askBtn.addEventListener('click', handleAskQuestion);

        /**
         * Fetches text from a URL.
         * @param {string} url - The URL of the text file.
         * @returns {Promise<string>} - The text content.
         */
        async function getTextFromUrl(url) {
            // 캐시 문제를 피하기 위해 URL에 타임스탬프를 추가합니다.
            const response = await fetch(`${url}?t=${new Date().getTime()}`);
            if (!response.ok) {
                throw new Error(`Failed to fetch ${url}: ${response.statusText}`);
            }
            return response.text();
        }
        
        /**
         * Loads the default text documents and enables the UI.
         */
        async function loadDefaultDocs() {
            showStatus('업무규정 문서를 불러오는 중입니다...', 'blue');
            askBtn.disabled = true;

            try {
                const textPromises = defaultDocUrls.map(url => getTextFromUrl(url));
                const allTexts = await Promise.all(textPromises);

                fullDocumentText = allTexts.join('\n\n--- (문서 구분) ---\n\n'); 
                
                showStatus('✅ 문서 로딩 완료! 질문을 입력하세요.', 'green');
                qaSection.classList.remove('opacity-50', 'pointer-events-none');
                askBtn.disabled = false;
                
            } catch (error) {
                console.error('Error loading default documents:', error);
                showStatus('❌ 문서를 불러오는 데 실패했습니다. GitHub 저장소가 Public인지, 파일 경로가 정확한지 확인해주세요.', 'red');
                fullDocumentText = '';
            }
        }

        /**
         * Sends the user's query and document content to the Gemini API.
         */
        async function handleAskQuestion() {
            const userQuery = queryInput.value.trim();
            if (!userQuery) {
                resultText.innerHTML = '<p class="text-red-500">질문을 입력해주세요.</p>';
                return;
            }
            if (!fullDocumentText) {
                resultText.innerHTML = '<p class="text-red-500">문서가 로딩되지 않았습니다.</p>';
                return;
            }

            loader.classList.remove('hidden');
            resultText.innerHTML = '';
            askBtn.disabled = true;
            askBtn.textContent = '답변 생성 중...';

            const systemPrompt = "당신은 사내 업무규정 전문가입니다. 제공된 2개의 업무규정 문서를 바탕으로 사용자의 질문에 대해 명확하고 간결하게, 알아보기 편하게 정리해서 답변해야 합니다. 답변은 항상 한국어로 작성해주세요. 문서에 명시되지 않은 내용에 대해서는 '문서에서 해당 내용을 찾을 수 없습니다.'라고 답변하세요.";
            const fullPrompt = `[업무 규정 문서]\n${fullDocumentText}\n\n[사용자 질문]\n${userQuery}`;

            try {
                const generatedText = await callGeminiApi(fullPrompt, systemPrompt);
                resultText.innerHTML = marked.parse(generatedText);
            } catch (error) {
                console.error('Error calling Gemini API:', error);
                resultText.innerHTML = '<p class="text-red-500">API 호출 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요.</p>';
            } finally {
                loader.classList.add('hidden');
                askBtn.disabled = false;
                askBtn.textContent = 'AI에게 질문하기';
            }
        }

        /**
         * Makes a POST request to the Gemini API with exponential backoff.
         */
        async function callGeminiApi(prompt, systemInstruction) {
            const apiKey = "AIzaSyDfpal-sPS5EeCLYrvmeVnc_sA69L_EQ8M";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
                generationConfig: { temperature: 0.5, topK: 1, topP: 1, maxOutputTokens: 2048 }
            };

            let retries = 3, delay = 1000;
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (text) return text;
                        throw new Error('Invalid API response structure');
                    }
                    if (response.status === 429 || response.status >= 500) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    } else {
                        const errorBody = await response.json();
                        throw new Error(`API error: ${errorBody.error?.message || response.status}`);
                    }
                } catch (error) {
                    if (i === retries - '1') throw error;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
            throw new Error('API request failed after retries.');
        }

        /**
         * Displays a status message to the user.
         */
        function showStatus(message, color) {
            docStatus.textContent = message;
            const colorClasses = {
                red: 'text-red-500',
                green: 'text-green-600',
                blue: 'text-blue-600'
            };
            docStatus.className = `text-center text-sm font-medium h-5 ${colorClasses[color] || ''}`;
        }
    </script>
</body>
</html>


